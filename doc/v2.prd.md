# PRD: Client-Side Data Fetching (The "Research OS" Pivot)

## 1. Executive Summary
**Goal**: Shift Reddit Keeper from a "Server-Side Scraper" (high cost/risk) to a "Client-Side Research OS" (zero cost/risk).
**Core Mechanism**: Users authenticate with their own Reddit account via OAuth. The application uses their token to fetch data directly from their browser to Reddit's API.
**User Value**: safer browsing (no IP bans), faster updates, and ethical compliance with Reddit's API terms for personal use.

## 2. User Stories
1.  **Connect Reddit**: As a user, I want to connect my Reddit account so that I can fetch data without hitting global rate limits.
2.  **Seamless Fetch**: As a user, I want to paste a URL and have it "just work," without knowing technical details about tokens or APIs.
3.  **Rate Limit Visibility**: As a user, I want to see if I'm approaching my personal Reddit API limit (60 req/min) so I can pace my research.

## 3. Functional Requirements

### 3.1 Authentication ("Login with Reddit")
*   **Provider**: Reddit OAuth2.
*   **Scopes**: `read`, `history`, `identity` (read-only scopes).
*   **Flow**:
    1.  User clicks "Connect Reddit" in Settings or Sidebar.
    2.  **User Consent Modal** appears:
        - Disclaimer: "You're using YOUR Reddit account and API quota."
        - Purpose: "This is for your personal research use."
        - Compliance: "You're responsible for Reddit ToS compliance."
        - Action: User must check "I understand" before proceeding.
    3.  Redirects to Reddit.com approval screen.
    4.  Redirects back to `/app/callback`.
    5.  App stores `access_token` and `refresh_token` in **Secure Local Storage** (or HTTP-only cookie) and logs consent timestamp.

### 3.2 Client-Side Fetching Engine
*   **Trigger**: User input in `UrlInput`.
*   **Logic**:
    1.  Check if User has valid Reddit Token.
    2.  **IF YES**:
        *   Browser makes direct `GET https://oauth.reddit.com/...` request.
        *   Upon success, sends JSON payload to *our* server (`/api/save-thread`) for storage/analysis.
    3.  **IF NO**:
        *   Prompt user to "Connect Reddit to fetch this thread."
        *   (Fallback: Use legacy server-fetch if we decide to keep a free tier, but PRD focuses on Auth).

### 3.3 The "Polite" Queue
*   **Problem**: If user pastes 10 URLs, we can't fire 10 simultaneous requests (client-side rate limiting).
*   **Solution**: Implement a client-side queue.
    *   Concurrency: 1 request at a time.
    *   Delay: 1000ms between requests.
    *   Feedback: Show "Fetching 1/10..." progress bar.

### 3.4 Usage Limits & Safeguards
*   **Daily Limits** (even within Reddit's API quota):
    - Free: 10 threads/day
    - Pro: 50 threads/day
    - Business: 200 threads/day
*   **Purpose**: 
    - Demonstrate responsible use.
    - Prevent "industrial-scale" harvesting.
    - Show good faith to Reddit.
*   **User Feedback**: 
    - "You've saved 8/10 threads today."
    - "Upgrade to Pro for 50 threads/day."

## 4. Technical Architecture

### 4.1 Frontend (React/Vite)
*   **New Services**:
    *   `RedditAuthService`: Handles login, token refresh, and token storage.
    *   `RedditClient`: A wrapper around `fetch` that automatically injects the Bearer token and handles 429 (Rate Limit) errors.
*   **Changes**:
    *   `UrlInput.tsx`: Remove call to `/api/fetch`. Replace with `RedditClient.fetchThread()` -> `Api.saveThread()`.

### 4.2 Backend (Node/Express)
*   **New Endpoints**:
    *   `POST /api/save-thread`: Accepts raw Reddit JSON (from client) and saves to Firestore.
    *   (No longer needs `/api/fetch` for authenticated users).
*   **Database**:
    *   `users/{uid}`: Add field `redditConnected: boolean` (Do NOT store tokens in DB).
*   **Data Storage & Attribution**:
    *   Store Reddit source URL with each thread (`originalRedditUrl` - required).
    *   Display "View Original on Reddit" in UI.
    *   Track `savedAt` timestamp (prove user's archive).
    *   Add `savedByUserId` (prove personal, not pooled).

## 5. Security & Privacy
*   **Tokens**: Access tokens are short-lived (1 hour). Refresh tokens must be stored securely.
*   **CORS**: Calls to `oauth.reddit.com` from `localhost` or `app.redditkeeper.com` are allowed **IF** the User Agent and Token are valid.

## 6. Phased Rollout
*   **Phase 1 (Hybrid)**:
    *   Add "Connect Reddit" button.
    *   If connected -> Use Client Fetch.
    *   If not connected -> Use Server Fetch (Legacy).
*   **Phase 2 (Pure)**:
    *   Remove Server Fetch.
    *   Require Reddit connection for all usage.

## 7. Legal Safeguards

### 7.1 User Terms
- **User Agreement**: Explicit clause stating "You use RedditKeeper with your own Reddit account."
- **Disclaimer**: "You're responsible for Reddit ToS compliance."
- **Data Ownership**: "Your saved threads are YOUR personal research archive."

### 7.2 Reddit Attribution
- All saved threads must link back to the original Reddit post.
- Attribution displayed prominently.
- "View Original on Reddit" button on every thread.

### 7.3 Usage Monitoring
- Track aggregate usage patterns to detect abuse.
- Alert if usage looks suspicious/excessive.
- Capability to disable users violating responsible use policies.

### 7.4 Prepared Response
- Document ready for potential Reddit inquiry.
- Explains OAuth approach and personal use model.
- Offers to discuss commercial licensing if needed.


